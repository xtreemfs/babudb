language: java
jdk: openjdk8

sudo: required
dist: trusty

before_script:
  # get and build protobuf
  - export PROTOBUF_VERSION=2.6.1
  - wget --output-document $HOME/protobuf-$PROTOBUF_VERSION.tar.gz https://github.com/google/protobuf/releases/download/v$PROTOBUF_VERSION/protobuf-$PROTOBUF_VERSION.tar.gz
  - cd $HOME
  - tar xf protobuf-$PROTOBUF_VERSION.tar.gz
  - cd protobuf-$PROTOBUF_VERSION
  - ./configure
  - make -j2
  - cd $TRAVIS_BUILD_DIR

  # configure maven repositories
  - echo "<settings xmlns=\"http://maven.apache.org/SETTINGS/1.0.0\""     >  $HOME/settings.xml
  - echo "  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\""      >> $HOME/settings.xml
  - echo "  xsi:schemaLocation=\"http://maven.apache.org/SETTINGS/1.0.0"  >> $HOME/settings.xml
  - echo "  https://maven.apache.org/xsd/settings-1.0.0.xsd\">"           >> $HOME/settings.xml
  - echo "  <profiles>"                                                   >> $HOME/settings.xml
  - echo "    <profile>"                                                  >> $HOME/settings.xml
  - echo "      <id>babudb-dev</id>"                                      >> $HOME/settings.xml
  - echo "      <repositories>"                                           >> $HOME/settings.xml
  - echo "        <repository>"                                           >> $HOME/settings.xml
  - echo "          <id>central</id>"                                     >> $HOME/settings.xml
  - echo "          <url>http://repo.maven.apache.org/maven2</url>"       >> $HOME/settings.xml
  - echo "        </repository>"                                          >> $HOME/settings.xml
  - echo "        <repository>"                                           >> $HOME/settings.xml
  - echo "          <id>xtreemfs-repository</id>"                         >> $HOME/settings.xml
  - echo "          <url>https://xtreemfs.github.io/xtreemfs/maven</url>" >> $HOME/settings.xml
  - echo "          <snapshots><enabled>true</enabled></snapshots>"       >> $HOME/settings.xml
  - echo "        </repository>"                                          >> $HOME/settings.xml
  - echo "      </repositories>"                                          >> $HOME/settings.xml
  - echo "    </profile>"                                                 >> $HOME/settings.xml
  - echo "  </profiles>"                                                  >> $HOME/settings.xml
  - echo "</settings>"                                                    >> $HOME/settings.xml

env:
  global:
   # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
   #   via the "travis encrypt" command using the project repo's public key
   - secure: "IknyImZ30I6yQifaPyhZDkMkFDzjkq9AoPzpcIExKWg/+krE416MuWJbMY7kLmjgNlv6rn1F326bouH5BxCz4yW2UOSYZFjkL60mXZWUSG5Ol2qXEGa0ku4SVwQi8eGk1gzP7P0GXrnrA7PkteioK93uqvS06GSNncuSDDHgpfM="

before_install:
  - echo -n | openssl s_client -connect scan.coverity.com:443 2>./openssl-connect.stderr | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-certificates.crt
  - echo "OpenSSL connect stderr:"
  - cat ./openssl-connect.stderr
  - rm ./openssl-connect.stderr

addons:
  coverity_scan:
    project:
      name: "xtreemfs/babudb"
      description: "An embedded non-relational database for Java and C++"
    notification_email: xtreemfs-test@googlegroups.com
    build_command_prepend: mvn --settings $HOME/settings.xml --activate-profiles babudb-dev --file $TRAVIS_BUILD_DIR/java/pom.xml clean
    build_command: mvn --settings $HOME/settings.xml --activate-profiles babudb-dev --file $TRAVIS_BUILD_DIR/java/pom.xml -Dprotoc.bin=$HOME/protobuf-$PROTOBUF_VERSION/src/protoc -Dprotoc.include=$HOME/protobuf-$PROTOBUF_VERSION/src -DskipTests install
    branch_pattern: coverity_scan

script:
  - true
